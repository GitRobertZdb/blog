<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Frameset//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-frameset.dtd">
<html>
    <head>
        <meta/>
        <meta charset="utf-8" />
        <meta http-equiv="Pragma" content="no-cache"/>
        <meta http-equiv="Cache-Control" content="no-cache"/>
        <meta http-equiv="Expires" content="0"/>
        <title>Blog MVC - MVC 异步断电续传大文件</title>
        
    

        <!--[if lt IE 9]>
            <script src="/Scripts/html5shiv.js"></script>
        <![endif]-->
        <link href="/Content/css/bootstrap.min.css" rel="stylesheet" type="text/css" />
        <link href="/Content/css/bootstrap-responsive.min.css" rel="stylesheet" type="text/css" />
        <link href="/Content/themes/base/jquery.ui.all.css" rel="stylesheet" type="text/css" />
        <link href="/Content/SyntaxHighlighter/shCoreDefault.css" rel="stylesheet" type="text/css" />
        <link href="/Views/Content/css/style.css" rel="stylesheet" type="text/css" />
        
<script type="text/javascript">
    var Urls = {};
    Urls.RootPath = '/';
    Urls.LoadingImgSmall = '/content/image/ajax-loader-small.gif';

    var Config = {};
    Config.DefaultLang = 'zh-cn';
    Config.IsPagingAjax = 'True';
</script>
        <script src="/Scripts/jquery-1.9.1.min.js" type="text/javascript"></script>
        <script src="/Scripts/jquery-ui-1.10.3.min.js" type="text/javascript"></script>
        <script src="/Scripts/bootstrap.min.js" type="text/javascript"></script>
        <script src="/Content/js/lang_zh-tw.js" type="text/javascript"></script>
        <script src="/Content/js/Web.Lang.zh-tw.js" type="text/javascript"></script>
        <script src="/Views/Content/js/site.js" type="text/javascript"></script>
        <script src="/Scripts/jquery.pager.js" type="text/javascript"></script>
        <script src="/Scripts/jquery.scrollUp.min.js" type="text/javascript"></script>
            <script src="/Scripts/jquery.ui.datepicker-zh-tw.js" type="text/javascript"></script>
    </head>
    <body>
        <header class="jumbotron">
            <div class="container">
<div  class="navbar navbar-inverse navbar-fixed-top">
      <div  class="navbar-inner">
                <div class="container">
                  <a data-target=".navbar-responsive-collapse" data-toggle="collapse" class="btn btn-navbar collapsed">
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                  </a>
                  <a href="/zh-tw" class="brand">首頁</a>
                  <div class="nav-collapse navbar-responsive-collapse in collapse" style="height: auto;">
                      <ul class="nav mainNav navbar-nav">
<li class="active hassub"><a href="http://localhost:8080/zh-tw/cate/60">MVC&EF<b class="menuarrow"></b></a>
<ul class="firstSubNav subNav">
<li><a href="http://localhost:8080/zh-tw/cate/65">MVC</a>
</li>
<li><a href="http://localhost:8080/zh-tw/cate/66">EF</a>
</li>
</ul>
</li>
<li class="hassub"><a href="http://localhost:8080/zh-tw/cate/61">Source<b class="menuarrow"></b></a>
<ul class="firstSubNav subNav">
<li class="hassub"><a href="http://localhost:8080/zh-tw/cate/67">后台<b class="menuarrow"></b></a>
<ul class="subNav">
<li><a href="http://localhost:8080/zh-tw/cate/72">.net webform</a>
</li>
<li><a href="http://localhost:8080/zh-tw/cate/73">.net mvc</a>
</li>
</ul>
</li>
<li class="hassub"><a href="http://localhost:8080/zh-tw/cate/68">前端<b class="menuarrow"></b></a>
<ul class="subNav">
<li><a href="http://localhost:8080/zh-tw/cate/69">javascript&jquery</a>
</li>
<li><a href="http://localhost:8080/zh-tw/cate/70">angularjs</a>
</li>
<li><a href="http://localhost:8080/zh-tw/cate/71">seajs</a>
</li>
</ul>
</li>
</ul>
</li>
<li class="hassub"><a href="http://localhost:8080/zh-tw/cate/62">Life Record<b class="menuarrow"></b></a>
<ul class="firstSubNav subNav">
<li><a href="http://localhost:8080/zh-tw/cate/63">travel</a>
</li>
<li><a href="http://localhost:8080/zh-tw/cate/64">from net</a>
</li>
<li><a href="http://localhost:8080/zh-tw/cate/75">sport</a>
</li>
<li><a href="http://localhost:8080/zh-tw/cate/80">胡小贝的精彩人生</a>
</li>
</ul>
</li>
<li><a href="http://localhost:8080/zh-tw/cate/74">Films&TV</a>
</li>
<li class="hassub"><a href="http://localhost:8080/zh-tw/cate/76">生活<b class="menuarrow"></b></a>
<ul class="firstSubNav subNav">
<li><a href="http://localhost:8080/zh-tw/cate/77">生活常识</a>
</li>
<li><a href="http://localhost:8080/zh-tw/cate/78">健康养生</a>
</li>
</ul>
</li>
</ul>

                    <ul class="nav pull-right" id="logonAndLangInfo"></ul>
                  </div>
                </div>
              </div>
            </div>            </div>
        </header>
        <div class="container">
            

<input type="hidden" value="13" id="ArticleId" name="ArticleId"/>
<div class="row">
    <div class="span12">
        <ul class="breadcrumb">
        <li><a href="/zh-tw">首頁</a> <span class="divider">/</span></li>
        <li><a href="http://localhost:8080/zh-tw/cate/60">MVC&EF</a> <span class="divider">/</span></li><li><a href="http://localhost:8080/zh-tw/cate/65">MVC</a> <span class="divider">/</span></li>
        <li class="active">MVC 异步断电续传大文件</li>
        </ul>
    </div>
    <div class="span12">
        <h3>MVC 异步断电续传大文件</h3>
        <p class="article_meta">
            <a href="http://localhost:8080/zh-tw/author/admin               ">admin</a>
            發表於
            2016-01-02 21:41
            <span class="ui-icon ui-icon-folder-collapsed"></span>
            <a href="http://localhost:8080/zh-tw/cate/65" >MVC</a>
            <span class="article_viewcount"></span>
            <span class="article_commentcount"></span>
        </p>
        <div>MVC 异步断电续传大文件</div>
        <div class="article_content"><p style="line-height:15px;margin:10px auto;color:#4B4B4B;font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:13px;white-space:normal;background-color:#FFFFFF;">
	MVC项目下上传大文件时遇到的问题，问题描述如下：
</p>
<p style="line-height:15px;margin:10px auto;color:#4B4B4B;font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:13px;white-space:normal;background-color:#FFFFFF;">
	<img src="http://localhost:2363/upload/article/20160102214122_2168.jpg" alt="" style="max-width:1000px;" /> 
</p>
<p style="line-height:15px;margin:10px auto;color:#4B4B4B;font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:13px;white-space:normal;background-color:#FFFFFF;">
	MVC项目中，当上传比较大的文件时，速度非常慢，小文件基本没有影响。
</p>
<h2 style="font-size:21px;color:#4B4B4B;font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;white-space:normal;background-color:#FFFFFF;">
	<span style="line-height:1.5;color:#FF9900;font-size:18pt;">原因分析：</span> 
</h2>
<p style="line-height:15px;margin:10px auto;color:#4B4B4B;font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:13px;white-space:normal;background-color:#FFFFFF;">
	如果是用传统的form表单去提交的话，会将整个文件一次性的加载到内存中然后再做保存，这个过程是相当慢的，特别是大文件，且上传文件容易受到各种因素的影响而导致上传失败，比如临时的网络故障等。
</p>
<h2 style="font-size:21px;color:#4B4B4B;font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;white-space:normal;background-color:#FFFFFF;">
	<span style="line-height:1.5;color:#FF9900;font-size:18pt;">如何解决？</span> 
</h2>
<p style="line-height:15px;margin:10px auto;color:#4B4B4B;font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:13px;white-space:normal;background-color:#FFFFFF;">
	<img src="http://localhost:2363/upload/article/20160102214122_2908.png" alt="" style="max-width:1000px;" /> 
</p>
<p style="line-height:15px;margin:10px auto;color:#4B4B4B;font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:13px;white-space:normal;background-color:#FFFFFF;">
	最直接的概念就是异步以及断点续传。
</p>
<h2 style="font-size:21px;color:#4B4B4B;font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;white-space:normal;background-color:#FFFFFF;">
	<span style="line-height:1.5;color:#FF9900;font-size:18pt;">为什么要异步</span> 
</h2>
<ol style="padding-left:40px;color:#4B4B4B;font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:13px;line-height:15px;white-space:normal;background-color:#FFFFFF;">
	<li style="list-style-type:decimal;">
		如果一个表单提交的元素中有文件上传的需求，如最终因为文件上传失败而影响整个表单数据的提交，这个体验性是非常差的。
	</li>
	<li style="list-style-type:decimal;">
		如果上传文件时间特别长，容易使应用程序长时间失去响应，给用户一个错觉，最好的方法是先让用户选择文件，此时点击上传，后台进行文件的异步上传，此时用户还可以继续去填写其它的表单元素，等用户填写完其它表单元素，文件有可能已经上传完成了，再提交表单，就只处理数据而不再上传文件了。增强了用户体验性。
	</li>
</ol>
<h2 style="font-size:21px;color:#4B4B4B;font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;white-space:normal;background-color:#FFFFFF;">
	<span style="line-height:1.5;color:#FF9900;font-size:18pt;">为什么要断点续传</span> 
</h2>
<p style="line-height:15px;margin:10px auto;color:#4B4B4B;font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:13px;white-space:normal;background-color:#FFFFFF;">
	在处理大文件时，无法忍受因为一时的网络原因导致上传失败，从而重新再上传的烦恼。好的方法是将一个大文件分成N个小块来进行上传，即使第一次失败了，之前上传的那部分由于得到了保留，再次点击上传时，以前已经传输成功的部分就不会再次被重新写入文件。注意，第二次上传时，文件还是从0开始传输到服务器，而不能根据服务器上的文件选择性的传输片断，这部分不太好节省，有兴趣的可以研究下。
</p>
<h2 style="font-size:21px;color:#4B4B4B;font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;white-space:normal;background-color:#FFFFFF;">
	<span style="line-height:1.5;color:#FF9900;font-size:18pt;">如何实现异步上传</span> 
</h2>
<p style="line-height:15px;margin:10px auto;color:#4B4B4B;font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:13px;white-space:normal;background-color:#FFFFFF;">
	这里可以利用jQuery的相应插件来完成，它的主要功能是将文件分割成N多个小块来批量上传,参考网址：<a href="https://github.com/blueimp/jQuery-File-Upload" style="color:#1A8BC8;text-decoration:none;">https://github.com/blueimp/jQuery-File-Upload</a> 
</p>
<h2 style="font-size:21px;color:#4B4B4B;font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;white-space:normal;background-color:#FFFFFF;">
	<span style="line-height:1.5;color:#FF9900;font-size:18pt;">如何实现断点续传</span> 
</h2>
<p style="line-height:15px;margin:10px auto;color:#4B4B4B;font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:13px;white-space:normal;background-color:#FFFFFF;">
	其实这个也非常简单，在Http头信息中有一个Conten-Range的属性，它会说明此次传递的文件内容的片断范围，我们只需要在后台解析这个范围稍加处理就可以实现。之所这么简单，是因为有了上面的jQuery 上传文件的插件，它负责将一个大文件分成N多小块进行传输，这就有了请求头中的Content-Range。
</p>
<p style="line-height:15px;margin:10px auto;color:#4B4B4B;font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:13px;white-space:normal;background-color:#FFFFFF;">
	我主要参考了<a href="http://weblogs.asp.net/bryansampica/archive/2013/01/15/AsyncMVCFileUpload.aspx" style="color:#1A8BC8;text-decoration:none;">http://weblogs.asp.net/bryansampica/archive/2013/01/15/AsyncMVCFileUpload.aspx</a>&nbsp;，但它没有完成对文件的保存功能，我这里加了断点续传的逻辑。
</p>
<p style="line-height:15px;margin:10px auto;color:#4B4B4B;font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:13px;white-space:normal;background-color:#FFFFFF;">
	<span style="line-height:1.5;color:#FF9900;">组件对于浏览器的要求</span> 
</p>
<p style="line-height:15px;margin:10px auto;color:#4B4B4B;font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:13px;white-space:normal;background-color:#FFFFFF;">
	看到大家对于js分割文件上传产生了不解，其实这个jQuery组件对浏览器是有要求的，利用了一些全新的api，上面文章中有提到浏览器的要求，对于只能使用低版本浏览器的项目来讲可能目前还有些问题，但异步上传是没问题的。
</p>
<blockquote style="border:2px solid #EFEFEF;padding:5px 10px;margin-top:10px;margin-bottom:10px;color:#4B4B4B;font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:13px;line-height:15px;white-space:normal;background:none #FFFFFF;">
	<p style="line-height:1.5;margin:10px auto;">
		Here it is running in Chrome:&nbsp; (Note:&nbsp; In Chrome, Firefox, and Safari you'll get a multiple file selection, in IE 9 and under, you wont.&nbsp; IE 10 you will)
	</p>
</blockquote>
<p style="line-height:15px;margin:10px auto;color:#4B4B4B;font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:13px;white-space:normal;background-color:#FFFFFF;">
	效果图：
</p>
<p style="line-height:15px;margin:10px auto;color:#4B4B4B;font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:13px;white-space:normal;background-color:#FFFFFF;">
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<img src="http://localhost:2363/upload/article/20160102214124_2499.jpg" alt="" style="max-width:1000px;" /> 
</p>
<p style="line-height:15px;margin:10px auto;color:#4B4B4B;font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:13px;white-space:normal;background-color:#FFFFFF;">
	可支持同时上传多个文件
</p>
<p style="line-height:15px;margin:10px auto;color:#4B4B4B;font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:13px;white-space:normal;background-color:#FFFFFF;">
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<img src="http://localhost:2363/upload/article/20160102214124_4739.jpg" alt="" style="max-width:1000px;" /> 
</p>
<p style="line-height:15px;margin:10px auto;color:#4B4B4B;font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:13px;white-space:normal;background-color:#FFFFFF;">
	上传成功后的效果
</p>
<p style="line-height:15px;margin:10px auto;color:#4B4B4B;font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:13px;white-space:normal;background-color:#FFFFFF;">
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<img src="http://localhost:2363/upload/article/20160102214125_2300.jpg" alt="" style="max-width:1000px;" /> 
</p>
<h2 style="font-size:21px;color:#4B4B4B;font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;white-space:normal;background-color:#FFFFFF;">
	<span style="line-height:1.5;color:#FF9900;font-size:18pt;">实现关键步骤：</span> 
</h2>
<p style="line-height:15px;margin:10px auto;color:#4B4B4B;font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:13px;white-space:normal;background-color:#FFFFFF;">
	<span style="line-height:1.5;color:#FF9900;font-size:18pt;"><img src="http://localhost:2363/upload/article/20160102214126_1020.jpg" alt="" style="max-width:1000px;" /></span> 
</p>
<p style="line-height:15px;margin:10px auto;color:#4B4B4B;font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:13px;white-space:normal;background-color:#FFFFFF;">
	&nbsp;
</p>
<ol style="padding-left:40px;color:#4B4B4B;font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:13px;line-height:15px;white-space:normal;background-color:#FFFFFF;">
	<li style="list-style-type:decimal;">
		引入jQuery上传文件组件
	</li>
	<li style="list-style-type:decimal;">
		初始化上传组件
	</li>
</ol>
<p style="line-height:15px;margin:10px auto;color:#4B4B4B;font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:13px;white-space:normal;background-color:#FFFFFF;">
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;主要是控制进展条的显示以及组件的部分参数，比如文件块大小等等。
</p>
<div class="cnblogs_Highlighter" style="color:#4B4B4B;font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:13px;line-height:15px;white-space:normal;background-color:#FFFFFF;">
<pre class="brush:javascript;gutter:true;" style="margin-top:0px;margin-bottom:0px;white-space:pre-wrap;word-wrap:break-word;">  $(function () {
            $('#fileupload').fileupload({
                dataType: "json",
                url: "/api/upload",
                limitConcurrentUploads: 1,
                sequentialUploads: true,
                progressInterval: 100,
                maxChunkSize: 10000,
                add: function (e, data) {
                    $('#filelistholder').removeClass('hide');
                    data.context = $('&lt;div /&gt;').text(data.files[0].name).appendTo('#filelistholder');
                    $('&lt;/div&gt;&lt;div class="progress"&gt;&lt;div class="bar" style="width:0%"&gt;&lt;/div&gt;&lt;/div&gt;').appendTo(data.context);
                    $('#btnUploadAll').click(function () {
                        data.submit();
                    });
                },
                done: function (e, data) {
                    data.context.text(data.files[0].name + '... Completed');
                    $('&lt;/div&gt;&lt;div class="progress"&gt;&lt;div class="bar" style="width:100%"&gt;&lt;/div&gt;&lt;/div&gt;').appendTo(data.context);
                },
                progressall: function (e, data) {
                    var progress = parseInt(data.loaded / data.total * 100, 10);
                    $('#overallbar').css('width', progress + '%');
                },
                progress: function (e, data) {
                    var progress = parseInt(data.loaded / data.total * 100, 10);
                    data.context.find('.bar').css('width', progress + '%');
                }
            });
        });
</pre>
</div>
<p style="line-height:15px;margin:10px auto;color:#4B4B4B;font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:13px;white-space:normal;background-color:#FFFFFF;">
	&nbsp;
</p>
<p style="line-height:15px;margin:10px auto;color:#4B4B4B;font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:13px;white-space:normal;background-color:#FFFFFF;">
	&nbsp;&nbsp;&nbsp; 3.&nbsp; 完成断点续传后台逻辑
</p>
<ul style="list-style:none;margin:0px 0px 10px 30px;padding-left:0px;font-size:12px;color:#4B4B4B;font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;white-space:normal;background-color:#FFFFFF;">
	<li style="list-style-type:disc;">
		&nbsp;首先通过api来配合jQuery上传组件对于上传进展条的一个监控&nbsp;&nbsp;。&nbsp;&nbsp;&nbsp;
	</li>
</ul>
<div class="cnblogs_Highlighter" style="color:#4B4B4B;font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:13px;line-height:15px;white-space:normal;background-color:#FFFFFF;">
<pre class="brush:csharp;gutter:true;" style="margin-top:0px;margin-bottom:0px;white-space:pre-wrap;word-wrap:break-word;">        [HttpGet]
        [HttpPost]
        public HttpResponseMessage Upload()
        {
            // Get a reference to the file that our jQuery sent.  Even with multiple files, they will all be their own request and be the 0 index
            HttpPostedFile file = HttpContext.Current.Request.Files[0];

            // do something with the file in this space 
            // {....}
            // end of file doing
            this.SaveAs(HttpContext.Current.Server.MapPath("~/Images/") + file.FileName, file);

            // Now we need to wire up a response so that the calling script understands what happened
            HttpContext.Current.Response.ContentType = "text/plain";
            var serializer = new System.Web.Script.Serialization.JavaScriptSerializer();
            var result = new { name = file.FileName };

            
            HttpContext.Current.Response.Write(serializer.Serialize(result));
            HttpContext.Current.Response.StatusCode = 200;

            // For compatibility with IE's "done" event we need to return a result as well as setting the context.response
            return new HttpResponseMessage(HttpStatusCode.OK);
        }
</pre>
</div>
<p style="line-height:15px;margin:10px auto;color:#4B4B4B;font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:13px;white-space:normal;background-color:#FFFFFF;">
	&nbsp;
</p>
<ul style="list-style:none;margin:0px 0px 10px 30px;padding-left:0px;font-size:12px;color:#4B4B4B;font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;white-space:normal;background-color:#FFFFFF;">
	<li style="list-style-type:disc;">
		实现断点续传逻辑
	</li>
</ul>
<p style="line-height:15px;margin:10px auto;color:#4B4B4B;font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:13px;white-space:normal;background-color:#FFFFFF;">
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;这其中主要是通过解析Http请求头中的Content-Range属性来获知此次处理的文件片断，后续就是基本的文件操作了，没什么可说的。
</p>
<div class="cnblogs_Highlighter" style="color:#4B4B4B;font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:13px;line-height:15px;white-space:normal;background-color:#FFFFFF;">
<pre class="brush:csharp;gutter:true;" style="margin-top:0px;margin-bottom:0px;white-space:pre-wrap;word-wrap:break-word;">        private void SaveAs(string saveFilePath, HttpPostedFile file)
        {
            long lStartPos = 0;
            int startPosition = 0;
            int endPosition = 0;
            var contentRange=HttpContext.Current.Request.Headers["Content-Range"];
            //bytes 10000-19999/1157632
            if (!string.IsNullOrEmpty(contentRange))
            {
                contentRange = contentRange.Replace("bytes", "").Trim();
                contentRange = contentRange.Substring(0, contentRange.IndexOf("/"));
                string[] ranges = contentRange.Split('-');
                startPosition = int.Parse(ranges[0]);
                endPosition = int.Parse(ranges[1]);
            }
            System.IO.FileStream fs;
            if (System.IO.File.Exists(saveFilePath))
            {
                fs = System.IO.File.OpenWrite(saveFilePath);
                lStartPos = fs.Length;
                
            }
            else
            {
                fs = new System.IO.FileStream(saveFilePath, System.IO.FileMode.Create);
                lStartPos = 0;
            }
            if (lStartPos &gt; endPosition)
            {
                fs.Close();
                return;
            }
            else if (lStartPos &lt; startPosition)
            {
                lStartPos = startPosition;
            }
            else if (lStartPos &gt; startPosition &amp;&amp; lStartPos &lt; endPosition)
            {
                lStartPos = startPosition;
            }
            fs.Seek(lStartPos, System.IO.SeekOrigin.Current);
            byte[] nbytes = new byte[512];
            int nReadSize = 0;
            nReadSize = file.InputStream.Read(nbytes, 0, 512);
            while (nReadSize &gt; 0)
            {
                fs.Write(nbytes, 0, nReadSize);
                nReadSize = file.InputStream.Read(nbytes, 0, 512);
            }
            fs.Close();           
        }
</pre>
</div>
<h2 style="font-size:21px;color:#4B4B4B;font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;white-space:normal;background-color:#FFFFFF;">
	<span style="line-height:1.5;color:#FF9900;font-size:18pt;">总结：</span><span style="line-height:1.5;color:#FF9900;font-size:18pt;">&nbsp;&nbsp;&nbsp;&nbsp;</span> 
</h2>
<p style="line-height:15px;margin:10px auto;color:#4B4B4B;font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;font-size:13px;white-space:normal;background-color:#FFFFFF;">
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; jQuery上传组件将大文件分割成小文件上传，正好解决了.net上传文件大小问题，只要将块大小配置好即可。利用Http头信息的Content-Range来实现断点续传，即解决了性能问题也解决了用户体验。
</p></div>
        <div class="article_tag muted">
                <a class="grayBoxA" href="http://localhost:8080/zh-tw/tag/MVC">MVC</a>
                <a class="grayBoxA" href="http://localhost:8080/zh-tw/tag/%e6%96%ad%e7%82%b9%e7%bb%ad%e4%bc%a0">断点续传</a>
                <a class="grayBoxA" href="http://localhost:8080/zh-tw/tag/%e6%96%87%e4%bb%b6%e4%b8%8a%e4%bc%a0">文件上传</a>
        </div>
        <div class="vote articlevote clearfix" voteid="13">
            <ul>
                <li>頂 :</li>
                <li class="vote_favor vote_favor_value"></li>
                <li class="gap"></li>
                <li>踩 :</li>
                <li class="vote_against vote_against_value"></li>
                <li class="vote_tip"></li>
            </ul>
        </div>
        <div class="article_link"></div>
        <div class="article_comment">
            <input type="hidden" value="desc" id="CommentOrderType" name="CommentOrderType"/>
            <a name="commentA"></a>
            <div id="commentlist">
            </div>
            <div id="commentform">
                <a name="commentFormA"></a>
                <h4>發表評論</h4>
                <div id="commentFormWrap"></div>
            </div>
        </div>
    </div>
</div>
<input type="hidden" value="" id="current-comment" name="current-comment"/>
<div id="modalbackdroptrue" class="modal hide fade">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h3>刪除評論</h3>
    </div>
    <div class="modal-body">
        <p>
            確定刪除選中項?
        </p>
    </div>
    <div class="modal-footer">
        <a class="btn btn-success fl" id="comment-delete-yes">是</a>
        <a data-dismiss="modal" class="btn btn-danger fl" id="comment-delete-no">否</a>
    </div>
</div>


        </div>
        <footer>
            <div class="container">
                版权所有  &copy; xxxx_jery_company
            </div>
        </footer>
<div id="themeSwitch">
    <a id="viewThemeList"><span class="ui-icon ui-icon-gear"></span></a>
    <div class="popover right nodisplay" id="themlistWrap">
        <div class="arrow"></div>
        <button class="close" type="button">×</button>
        <h3 class="popover-title clearfix">
            模板設置
        </h3>
        <div class="popover-content">
            <p class="currenttheme">Default</p>
            <ul>
                    <li><span class="themeindex">1</span><a href="?theme=bs3">BootStrap3</a></li>
            </ul>
        </div>
    </div>
</div>        
    <script src="/Scripts/SyntaxHighlighter/scripts/shCore.js" type="text/javascript"></script>
    <script src="/Scripts/SyntaxHighlighter/scripts/shBrush.js" type="text/javascript"></script>
    <script type="text/javascript">
        $(function () {
            $('.article_link').html(loadingImgSmall);
            GetArticleAjaxInfo();
            GetCommentForm();
            SyntaxHighlighter.all();
        });
    </script>

    
<!-- Visual Studio Browser Link -->
<script type="application/json" id="__browserLink_initializationData">
    {"appName":"Unknown"}
</script>
<script type="text/javascript" src="http://localhost:52802/d7b292a5fb244ceb8c4b180f13d5cf01/browserLink" async="async"></script>
<!-- End Browser Link -->

</body>
</html>