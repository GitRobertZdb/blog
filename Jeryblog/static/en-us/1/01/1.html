<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Frameset//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-frameset.dtd">
<html>
    <head>
        <meta charset="utf-8" />
        <title></title>
        
    

        <link href="/Content/css/bootstrap.min.css" rel="stylesheet" type="text/css" />
        <link href="/Content/css/bootstrap-responsive.min.css" rel="stylesheet" type="text/css" />
        <link href="/Content/themes/base/jquery.ui.all.css" rel="stylesheet" type="text/css" />
        <link href="/Content/SyntaxHighlighter/shCoreDefault.css" rel="stylesheet" type="text/css" />
        <link href="/Views/Content/css/style.css" rel="stylesheet" type="text/css" />
        
<script type="text/javascript">
    var Urls = {};
    Urls.RootPath = '/';
    Urls.LoadingImgSmall = '/content/image/ajax-loader-small.gif';

    var Config = {};
    Config.DefaultLang = 'zh-cn';
    Config.IsPagingAjax = 'True';
</script>
        <script src="/Scripts/jquery-1.9.1.min.js" type="text/javascript"></script>
        <script src="/Scripts/jquery-ui-1.10.3.min.js" type="text/javascript"></script>
        <script src="/Scripts/bootstrap.min.js" type="text/javascript"></script>
        <script src="/Content/js/lang_en-us.js" type="text/javascript"></script>
        <script src="/Content/js/Web.Lang.en-us.js" type="text/javascript"></script>
        <script src="/Views/Content/js/site.js" type="text/javascript"></script>
        <script src="/Scripts/jquery.pager.js" type="text/javascript"></script>
        <script src="/Scripts/jquery.scrollUp.min.js" type="text/javascript"></script>
    </head>
    <body>
<div class="navbar navbar-inverse navbar-fixed-top">
      <div class="navbar-inner">
                <div class="container">
                  <a data-target=".navbar-responsive-collapse" data-toggle="collapse" class="btn btn-navbar collapsed">
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                  </a>
                  <a href="/" class="brand">Home</a>
                  <div class="nav-collapse navbar-responsive-collapse in collapse" style="height: auto;">
                    <ul class="nav">
                      <ul class="nav mainNav">
<li class="active hassub"><a href="http://localhost:2363/en-us/cate/60">MVC&EF<b class="menuarrow"></b></a>
<ul class="firstSubNav subNav">
<li><a href="http://localhost:2363/en-us/cate/65">MVC</a>
</li>
<li><a href="http://localhost:2363/en-us/cate/66">EF</a>
</li>
</ul>
</li>
<li class="hassub"><a href="http://localhost:2363/en-us/cate/61">Source<b class="menuarrow"></b></a>
<ul class="firstSubNav subNav">
<li class="hassub"><a href="http://localhost:2363/en-us/cate/67">后台<b class="menuarrow"></b></a>
<ul class="subNav">
<li><a href="http://localhost:2363/en-us/cate/72">.net webform</a>
</li>
<li><a href="http://localhost:2363/en-us/cate/73">.net mvc</a>
</li>
</ul>
</li>
<li class="hassub"><a href="http://localhost:2363/en-us/cate/68">前端<b class="menuarrow"></b></a>
<ul class="subNav">
<li><a href="http://localhost:2363/en-us/cate/69">javascript&jquery</a>
</li>
<li><a href="http://localhost:2363/en-us/cate/70">angularjs</a>
</li>
<li><a href="http://localhost:2363/en-us/cate/71">seajs</a>
</li>
</ul>
</li>
</ul>
</li>
<li class="hassub"><a href="http://localhost:2363/en-us/cate/62">life history<b class="menuarrow"></b></a>
<ul class="firstSubNav subNav">
<li><a href="http://localhost:2363/en-us/cate/63">travel</a>
</li>
<li><a href="http://localhost:2363/en-us/cate/64">from net</a>
</li>
</ul>
</li>
<li><a href="http://localhost:2363/en-us/cate/74">Films&TV</a>
</li>
</ul>

                    </ul>
                    <ul class="nav pull-right" id="logonAndLangInfo"></ul>
                  </div>
                </div>
              </div>
            </div>
        <header class="jumbotron">
            <div class="container">
            </div>
        </header>
        <div class="container">
            

<input type="hidden" value="1" id="ArticleId" name="ArticleId"/>
<div class="row">
    <div class="span12">
        <ul class="breadcrumb">
        <li><a href="/en-us">Home</a> <span class="divider">/</span></li>
        <li><a href="http://localhost:2363/en-us/cate/60">MVC&EF</a> <span class="divider">/</span></li><li><a href="http://localhost:2363/en-us/cate/66">EF</a> <span class="divider">/</span></li>
        <li class="active">乐观并发</li>
        </ul>
    </div>
    <div class="span12">
        <h3>乐观并发</h3>
        <p class="article_meta">
            <a href="http://localhost:2363/en-us/author/admin               ">admin</a>
            posted on
            Jan. 2, 2016 13:41
            <span class="ui-icon ui-icon-folder-collapsed"></span>
            <a href="http://localhost:2363/en-us/cate/66" >EF</a>
            <span class="article_viewcount"></span>
            <span class="article_commentcount"></span>
        </p>
        <div>EF 乐观并发</div>
        <div class="article_content"><p style="margin-top:0px;padding:0px;border:0px;list-style:none;word-wrap:normal;word-break:normal;line-height:21px;color:#555555;font-family:simsun;white-space:normal;">
	<span style="white-space:nowrap;"><strong>这篇文章讨论乐观并发。</strong></span> 
</p>
<p style="margin-top:0px;padding:0px;border:0px;list-style:none;word-wrap:normal;word-break:normal;line-height:21px;color:#555555;font-family:simsun;">
	<span style="white-space:nowrap;"><b><br />
</b></span> <span style="white-space:nowrap;">&nbsp;&nbsp;我们经常要面对多用户并发访问问题。这是因为人访问机器的速度无法与高速的机器匹配，典型情况下，人需要大约一分钟或者更多来填写数据，而机器的交易处理通常只需要不到一秒钟。</span><br />
<span style="white-space:nowrap;">在用户编辑相应数据的时候，我们不能让数据库的事务处理保持打开，这有许多原因：连接问题，信任问题，技术原因等等。基于这些原因，我们需要并发管理。有两种管理方法：乐观和悲观。悲观方式更难处理，因为你需要实现基于记录的锁定机制，而且还随之而来带来一些问题，例如，在自动释放锁之前，系统应该锁定多长的时间。乐观并发要简单一些。</span><br />
<span style="white-space:nowrap;">乐观并发基于的一个基本的假设是用户的修改很少冲突。对于很少用户同时编辑同样数据的应用来说，不管有很多用户还是很少的用户都是成立的。基本的考虑是为访问数据的用户提供一个数据的版本，当用户以后回来更新数据的时候，通过版本来确认原来的数据，如果数据已经在后台被其他操作更新，版本发生了变化，我们就可以通过版本检测到，然后拒绝更新。</span><br />
<span style="white-space:nowrap;">可以有许多方式来实现版本，包括通过一个版本数字来关联到数据，可以是最后一次修改的日期时间字段，还可能是多于一个的字段。在 EF 中，这被称为并发标识 concurrenty token，在这篇文章中，我使用 SQL Server 的 time-stamp 特性，这需要在表中增加一个 time-stamp 类型的列，我们通过它来实现乐观并发。由 SQL Server 在每次记录被更新的时候维护这个列。</span><br />
<span style="white-space:nowrap;">为了告诉 EF 在实体中有一个属性表示并发标识，你可以通过标签 [ConcurrencyCheck] 来标识这个属性，或者使用模型构建器。我认为并发标识定义了业务规则，应该是模型的一部分。所以这里使用标签。</span><br />
<span style="white-space:nowrap;">public class Order</span><br />
<span style="white-space:nowrap;">{</span><br />
<span style="white-space:nowrap;">public int OrderID { get; set; }</span><br />
<span style="white-space:nowrap;">[Required]</span><br />
<span style="white-space:nowrap;">[StringLength(32, MinimumLength = 2)]</span><br />
<span style="white-space:nowrap;">public string OrderTitle { get; set; }</span><br />
<span style="white-space:nowrap;">[Required]</span><br />
<span style="white-space:nowrap;">[StringLength(64, MinimumLength=5)]</span><br />
<span style="white-space:nowrap;">public string CustomerName { get; set; }</span><br />
<span style="white-space:nowrap;">public DateTime TransactionDate { get; set; }</span><br />
<span style="white-space:nowrap;">[ConcurrencyCheck]</span><br />
<span style="white-space:nowrap;">[Timestamp]</span><br />
<span style="white-space:nowrap;">public byte[] TimeStamp { get; set; }</span><br />
<span style="white-space:nowrap;"><br />
</span><br />
<span style="white-space:nowrap;">public virtual List&lt;OrderDetail&gt; OrderDetails { get; set; }</span><br />
<span style="white-space:nowrap;">public virtual List&lt;Employee&gt; InvolvedEmployees { get; set; }</span><br />
<span style="white-space:nowrap;">}</span><br />
<span style="white-space:nowrap;">在这段代码中，当我们通过 DbContext 调用 SaveChanges 的时候，将会使用乐观并发。</span><br />
<span style="white-space:nowrap;">Timestamp 属性的类型是 byte[], 通过标签 Timestamp ，将这个属性映射到 SQL Server 的 time-stamp 类型的列。</span><br />
<span style="white-space:nowrap;">现在，我们模拟并发，我们将执行下面的三个步骤：</span><br />
<span style="white-space:nowrap;">创建一个订单</span><br />
<span style="white-space:nowrap;">模拟用户 X 修改这个订单</span><br />
<span style="white-space:nowrap;">模拟用户 Y 修改这个订单，此时订单已经被修改，而用户 Y 不知道。</span><br />
<span style="white-space:nowrap;">通过在另一个 DbContext 中连接实体来模拟修改的过程，当我们通过 DbContet 连接实体的时候，它会假设实体没有被修改，所以我们在它之后进行修改。</span><br />
<span style="white-space:nowrap;">private static void ConcurrencyCheck()</span><br />
<span style="white-space:nowrap;">{</span><br />
<span style="white-space:nowrap;">Order originalOrder;</span><br />
<span style="white-space:nowrap;"><br />
</span><br />
<span style="white-space:nowrap;">// Create an order&nbsp;</span><br />
<span style="white-space:nowrap;">using (var context1 = new MyDomainContext())</span><br />
<span style="white-space:nowrap;">{</span><br />
<span style="white-space:nowrap;">originalOrder = new Order</span><br />
<span style="white-space:nowrap;">{</span><br />
<span style="white-space:nowrap;">OrderTitle = "Paper",</span><br />
<span style="white-space:nowrap;">CustomerName = "*Bob*",</span><br />
<span style="white-space:nowrap;">TransactionDate = DateTime.Now</span><br />
<span style="white-space:nowrap;">};</span><br />
<span style="white-space:nowrap;"><br />
</span><br />
<span style="white-space:nowrap;">context1.Orders.Add(originalOrder);</span><br />
<span style="white-space:nowrap;">context1.SaveChanges();</span><br />
<span style="white-space:nowrap;">}</span><br />
<span style="white-space:nowrap;">// Simulate the modification of the created order by user X&nbsp;</span><br />
<span style="white-space:nowrap;">using (var context2 = new MyDomainContext())</span><br />
<span style="white-space:nowrap;">{ // Recreate the order object in order to attach it&nbsp;</span><br />
<span style="white-space:nowrap;">var order = new Order</span><br />
<span style="white-space:nowrap;">{</span><br />
<span style="white-space:nowrap;">OrderID = originalOrder.OrderID,</span><br />
<span style="white-space:nowrap;">OrderTitle = originalOrder.OrderTitle,</span><br />
<span style="white-space:nowrap;">CustomerName = originalOrder.CustomerName,</span><br />
<span style="white-space:nowrap;">TransactionDate = originalOrder.TransactionDate,</span><br />
<span style="white-space:nowrap;">TimeStamp = originalOrder.TimeStamp</span><br />
<span style="white-space:nowrap;">};</span><br />
<span style="white-space:nowrap;"><br />
</span><br />
<span style="white-space:nowrap;">context2.Orders.Attach(order);</span><br />
<span style="white-space:nowrap;"><br />
</span><br />
<span style="white-space:nowrap;">// Alter the order&nbsp;</span><br />
<span style="white-space:nowrap;">order.CustomerName = "Robert";</span><br />
<span style="white-space:nowrap;"><br />
</span><br />
<span style="white-space:nowrap;">context2.SaveChanges();</span><br />
<span style="white-space:nowrap;">}</span><br />
<span style="white-space:nowrap;">// Simulate the modification of the created order by user Y (after user X already modified it)&nbsp;</span><br />
<span style="white-space:nowrap;">using (var context3 = new MyDomainContext())</span><br />
<span style="white-space:nowrap;">{ // Recreate the order in order to attach it&nbsp;</span><br />
<span style="white-space:nowrap;">var order = new Order</span><br />
<span style="white-space:nowrap;">{</span><br />
<span style="white-space:nowrap;">OrderID = originalOrder.OrderID,</span><br />
<span style="white-space:nowrap;">OrderTitle = originalOrder.OrderTitle,</span><br />
<span style="white-space:nowrap;">CustomerName = originalOrder.CustomerName,</span><br />
<span style="white-space:nowrap;">TransactionDate = originalOrder.TransactionDate,</span><br />
<span style="white-space:nowrap;">TimeStamp = originalOrder.TimeStamp</span><br />
<span style="white-space:nowrap;">};</span><br />
<span style="white-space:nowrap;"><br />
</span><br />
<span style="white-space:nowrap;">context3.Orders.Attach(order);</span><br />
<span style="white-space:nowrap;"><br />
</span><br />
<span style="white-space:nowrap;">// Alter the order&nbsp;</span><br />
<span style="white-space:nowrap;">order.CustomerName = "Luke**";</span><br />
<span style="white-space:nowrap;"><br />
</span><br />
<span style="white-space:nowrap;">try&nbsp;</span><br />
<span style="white-space:nowrap;">{</span><br />
<span style="white-space:nowrap;">context3.SaveChanges();</span><br />
<span style="white-space:nowrap;">}</span><br />
<span style="white-space:nowrap;">catch (DbUpdateConcurrencyException ex)</span><br />
<span style="white-space:nowrap;">{</span><br />
<span style="white-space:nowrap;">Console.WriteLine("Concurrency exception on "   ex.Entries.First().Entity.GetType().Name);</span><br />
<span style="white-space:nowrap;">}</span><br />
<span style="white-space:nowrap;">}</span><br />
<span style="white-space:nowrap;">}</span><br />
<span style="white-space:nowrap;">你也可以强制 EF 相信订单已经被修改了。</span><br />
<span style="white-space:nowrap;">context3.Entry(order).State = EntityState.Modified;</span><br />
<span style="white-space:nowrap;">所以，EF 提供了开箱即用的乐观并发支持，这个窍门也可以用在 EF 状态的各个方面：当你连接实体的时候，确信它们处于正确的状态。</span><br />
<span style="white-space:nowrap;">Detached</span><br />
<span style="white-space:nowrap;">Unchanged</span><br />
<span style="white-space:nowrap;">Added</span><br />
<span style="white-space:nowrap;">Deleted</span><br />
<span style="white-space:nowrap;">Modified</span> 
</p></div>
        <div class="article_tag muted">
                <a class="grayBoxA" href="http://localhost:2363/en-us/tag/EF">EF</a>
                <a class="grayBoxA" href="http://localhost:2363/en-us/tag/%e5%b9%b6%e5%8f%91">并发</a>
                <a class="grayBoxA" href="http://localhost:2363/en-us/tag/%e4%b9%90%e8%a7%82%e5%b9%b6%e5%8f%91">乐观并发</a>
        </div>
        <div class="vote articlevote clearfix" voteid="1">
            <ul>
                <li>Bump :</li>
                <li class="vote_favor vote_favor_value"></li>
                <li class="gap"></li>
                <li>Stamp :</li>
                <li class="vote_against vote_against_value"></li>
                <li class="vote_tip"></li>
            </ul>
        </div>
        <div class="article_link"></div>
        <div class="article_comment">
            <input type="hidden" value="desc" id="CommentOrderType" name="CommentOrderType"/>
            <div id="commentform">
                <a name="commentFormA"></a>
                <h4>Add Comment</h4>
                <div id="commentFormWrap"></div>
            </div>
            <a name="commentA"></a>
            <div id="commentlist">
            </div>
        </div>
    </div>
</div>
<input type="hidden" value="" id="current-comment" name="current-comment"/>
<div id="modalbackdroptrue" class="modal hide fade">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h3>Delete Comment</h3>
    </div>
    <div class="modal-body">
        <p>
            Are you sure to delete this item?
        </p>
    </div>
    <div class="modal-footer">
        <a class="btn btn-success fl" id="comment-delete-yes">Yes</a>
        <a data-dismiss="modal" class="btn btn-danger fl" id="comment-delete-no">No</a>
    </div>
</div>


        </div>
        <footer>
            <div class="container">
               Copyright &copy; jeryBlog All Rights Reserved
            </div>
        </footer>
        
    <script src="/Scripts/SyntaxHighlighter/scripts/shCore.js" type="text/javascript"></script>
    <script src="/Scripts/SyntaxHighlighter/scripts/shBrush.js" type="text/javascript"></script>
    <script type="text/javascript">
        $(function () {
            $('.article_link').html(loadingImgSmall);
            GetArticleAjaxInfo();
            GetCommentForm();
            SyntaxHighlighter.all();
        });
    </script>

    
<!-- Visual Studio Browser Link -->
<script type="application/json" id="__browserLink_initializationData">
    {"appName":"Unknown"}
</script>
<script type="text/javascript" src="http://localhost:39544/f70bbb0a013a4fe09667f4058ae25e14/browserLink" async="async"></script>
<!-- End Browser Link -->

</body>
</html>