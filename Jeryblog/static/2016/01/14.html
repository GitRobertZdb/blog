<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Frameset//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-frameset.dtd">
<html>
    <head>
        <meta/>
        <meta charset="utf-8" />
        <meta http-equiv="Pragma" content="no-cache"/>
        <meta http-equiv="Cache-Control" content="no-cache"/>
        <meta http-equiv="Expires" content="0"/>
        <title>Blog MVC - mvc sso单点登录</title>
        
    

        <!--[if lt IE 9]>
            <script src="/Scripts/html5shiv.js"></script>
        <![endif]-->
        <link href="/Content/css/bootstrap.min.css" rel="stylesheet" type="text/css" />
        <link href="/Content/css/bootstrap-responsive.min.css" rel="stylesheet" type="text/css" />
        <link href="/Content/themes/base/jquery.ui.all.css" rel="stylesheet" type="text/css" />
        <link href="/Content/SyntaxHighlighter/shCoreDefault.css" rel="stylesheet" type="text/css" />
        <link href="/Views/Content/css/style.css" rel="stylesheet" type="text/css" />
        
<script type="text/javascript">
    var Urls = {};
    Urls.RootPath = '/';
    Urls.LoadingImgSmall = '/content/image/ajax-loader-small.gif';

    var Config = {};
    Config.DefaultLang = 'zh-cn';
    Config.IsPagingAjax = 'True';
</script>
        <script src="/Scripts/jquery-1.9.1.min.js" type="text/javascript"></script>
        <script src="/Scripts/jquery-ui-1.10.3.min.js" type="text/javascript"></script>
        <script src="/Scripts/bootstrap.min.js" type="text/javascript"></script>
        <script src="/Content/js/lang_zh-cn.js" type="text/javascript"></script>
        <script src="/Content/js/Web.Lang.zh-cn.js" type="text/javascript"></script>
        <script src="/Views/Content/js/site.js" type="text/javascript"></script>
        <script src="/Scripts/jquery.pager.js" type="text/javascript"></script>
        <script src="/Scripts/jquery.scrollUp.min.js" type="text/javascript"></script>
            <script src="/Scripts/jquery.ui.datepicker-zh-cn.js" type="text/javascript"></script>
    </head>
    <body>
        <header class="jumbotron">
            <div class="container">
<div  class="navbar navbar-inverse navbar-fixed-top">
      <div  class="navbar-inner">
                <div class="container">
                  <a data-target=".navbar-responsive-collapse" data-toggle="collapse" class="btn btn-navbar collapsed">
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                  </a>
                  <a href="/" class="brand">首页</a>
                  <div class="nav-collapse navbar-responsive-collapse in collapse" style="height: auto;">
                      <ul class="nav mainNav navbar-nav">
<li class="active hassub"><a href="http://localhost:8080/cate/60">MVC&EF<b class="menuarrow"></b></a>
<ul class="firstSubNav subNav">
<li><a href="http://localhost:8080/cate/65">MVC</a>
</li>
<li><a href="http://localhost:8080/cate/66">EF</a>
</li>
</ul>
</li>
<li class="hassub"><a href="http://localhost:8080/cate/61">Source<b class="menuarrow"></b></a>
<ul class="firstSubNav subNav">
<li class="hassub"><a href="http://localhost:8080/cate/67">后台<b class="menuarrow"></b></a>
<ul class="subNav">
<li><a href="http://localhost:8080/cate/72">.net webform</a>
</li>
<li><a href="http://localhost:8080/cate/73">.net mvc</a>
</li>
</ul>
</li>
<li class="hassub"><a href="http://localhost:8080/cate/68">前端<b class="menuarrow"></b></a>
<ul class="subNav">
<li><a href="http://localhost:8080/cate/69">javascript&jquery</a>
</li>
<li><a href="http://localhost:8080/cate/70">angularjs</a>
</li>
<li><a href="http://localhost:8080/cate/71">seajs</a>
</li>
</ul>
</li>
</ul>
</li>
<li class="hassub"><a href="http://localhost:8080/cate/62">Life Record<b class="menuarrow"></b></a>
<ul class="firstSubNav subNav">
<li><a href="http://localhost:8080/cate/63">travel</a>
</li>
<li><a href="http://localhost:8080/cate/64">from net</a>
</li>
<li><a href="http://localhost:8080/cate/75">sport</a>
</li>
<li><a href="http://localhost:8080/cate/80">胡小贝的精彩人生</a>
</li>
</ul>
</li>
<li><a href="http://localhost:8080/cate/74">Films&TV</a>
</li>
<li class="hassub"><a href="http://localhost:8080/cate/76">生活<b class="menuarrow"></b></a>
<ul class="firstSubNav subNav">
<li><a href="http://localhost:8080/cate/77">生活常识</a>
</li>
<li><a href="http://localhost:8080/cate/78">健康养生</a>
</li>
</ul>
</li>
</ul>

                    <ul class="nav pull-right" id="logonAndLangInfo"></ul>
                  </div>
                </div>
              </div>
            </div>            </div>
        </header>
        <div class="container">
            

<input type="hidden" value="14" id="ArticleId" name="ArticleId"/>
<div class="row">
    <div class="span12">
        <ul class="breadcrumb">
        <li><a href="/">首页</a> <span class="divider">/</span></li>
        <li><a href="http://localhost:8080/cate/60">MVC&EF</a> <span class="divider">/</span></li><li><a href="http://localhost:8080/cate/65">MVC</a> <span class="divider">/</span></li>
        <li class="active">mvc sso单点登录</li>
        </ul>
    </div>
    <div class="span12">
        <h3>mvc sso单点登录</h3>
        <p class="article_meta">
            <a href="http://localhost:8080/author/admin               ">admin</a>
            发表于
            2016-01-02 21:44
            <span class="ui-icon ui-icon-folder-collapsed"></span>
            <a href="http://localhost:8080/cate/65" >MVC</a>
            <span class="article_viewcount"></span>
            <span class="article_commentcount"></span>
        </p>
        <div>mvc sso单点登录</div>
        <div class="article_content"><h1 class="postTitle" style="margin:0px;padding:0px 0px 0px 5px;font-size:15.6px;border:none;float:left;line-height:2em;width:944.676px;clear:both;font-family:'Microsoft YaHei', Verdana, Arial, Helvetica, sans-serif;white-space:normal;background-color:#FFFFFF;">
	<a id="cb_post_title_url" class="postTitle2" href="http://www.cnblogs.com/smartbooks/p/3800849.html" style="margin:0px;padding:0px;color:#428CB2;text-decoration:none;font-size:31.2px;" se_prerender_url="loading">MVC SSO单点登录设计与实现</a> 
</h1>
<div class="clear" style="margin:0px;padding:0px;clear:both;font-family:'Microsoft YaHei', Verdana, Arial, Helvetica, sans-serif;font-size:12px;line-height:normal;white-space:normal;background-color:#FFFFFF;">
</div>
<div class="postBody" style="margin:0px;padding:5px 2px 5px 5px;line-height:1.5;border-bottom-width:1px;border-bottom-style:solid;border-bottom-color:black;font-size:1.1em;font-family:'Microsoft YaHei', Verdana, Arial, Helvetica, sans-serif;white-space:normal;background-color:#FFFFFF;">
	<div id="cnblogs_post_body" style="margin:0px 0px 20px;padding:0px;word-break:break-word;">
		<p style="margin:12px auto;padding:0px;line-height:22px;">
			&nbsp;
		</p>
		<h1 style="margin:0px;padding:0px;font-size:28px;">
			实验环境配置
		</h1>
		<h2 style="margin:15px auto 2px;padding:0px;font-size:21px;color:#343434;border:1px solid #666666;border-radius:5px;text-shadow:#CECECE 1px 1px 1px;box-shadow:#A3A3A3 1px 1px 2px;line-height:1.5em;background:rgba(68, 199, 250, 0.298039);">
			HOST文件配置如下：
		</h2>
		<p style="margin:12px auto;padding:0px;line-height:22px;">
			127.0.0.1 app.com<br style="margin:0px;padding:0px;" />
127.0.0.1 sso.com
		</p>
		<h2 style="margin:15px auto 2px;padding:0px;font-size:21px;color:#343434;border:1px solid #666666;border-radius:5px;text-shadow:#CECECE 1px 1px 1px;box-shadow:#A3A3A3 1px 1px 2px;line-height:1.5em;background:rgba(68, 199, 250, 0.298039);">
			IIS配置如下：
		</h2>
		<p style="margin:12px auto;padding:0px;line-height:22px;">
			<img src="http://localhost:2363/upload/article/20160102214414_2327.png" alt="" style="margin:0px;padding:0px;max-width:1000px;" /> 
		</p>
		<p style="margin:12px auto;padding:0px;line-height:22px;">
			应用程序池采用.Net Framework 4.0
		</p>
		<p style="margin:12px auto;padding:0px;line-height:22px;">
			<img src="http://localhost:2363/upload/article/20160102214415_7277.png" alt="" style="margin:0px;padding:0px;max-width:1000px;" /> 
		</p>
		<p style="margin:12px auto;padding:0px;line-height:22px;">
			注意IIS绑定的域名，两个完全不同域的域名。
		</p>
		<h2 style="margin:15px auto 2px;padding:0px;font-size:21px;color:#343434;border:1px solid #666666;border-radius:5px;text-shadow:#CECECE 1px 1px 1px;box-shadow:#A3A3A3 1px 1px 2px;line-height:1.5em;background:rgba(68, 199, 250, 0.298039);">
			app.com网站配置如下：
		</h2>
		<p style="margin:12px auto;padding:0px;line-height:22px;">
			&nbsp;<img src="http://localhost:2363/upload/article/20160102214416_5708.png" alt="" style="margin:0px;padding:0px;max-width:1000px;" /> 
		</p>
		<h2 style="margin:15px auto 2px;padding:0px;font-size:21px;color:#343434;border:1px solid #666666;border-radius:5px;text-shadow:#CECECE 1px 1px 1px;box-shadow:#A3A3A3 1px 1px 2px;line-height:1.5em;background:rgba(68, 199, 250, 0.298039);">
			&nbsp;sso.com网站配置如下：
		</h2>
		<h3 style="margin:15px auto 2px;padding:0px;font-size:16px;border-bottom-width:2px;border-bottom-style:solid;border-bottom-color:#C9A30A;line-height:2em;">
			memcached缓存：
		</h3>
		<p style="margin:12px auto;padding:0px;line-height:22px;">
			<img src="http://localhost:2363/upload/article/20160102214417_8479.png" alt="" style="margin:0px;padding:0px;max-width:1000px;" /> 
		</p>
		<h3 style="margin:15px auto 2px;padding:0px;font-size:16px;border-bottom-width:2px;border-bottom-style:solid;border-bottom-color:#C9A30A;line-height:2em;">
			&nbsp;数据库配置：
		</h3>
		<p style="margin:12px auto;padding:0px;line-height:22px;">
			<img src="http://localhost:2363/upload/article/20160102214418_1679.png" alt="" style="margin:0px;padding:0px;max-width:1000px;" /> 
		</p>
		<p style="margin:12px auto;padding:0px;line-height:22px;">
			&nbsp;数据库采用EntityFramework&nbsp;6.0.0，首次运行会自动创建相应的数据库和表结构。
		</p>
		<h1 style="margin:0px;padding:0px;font-size:28px;">
			授权验证过程演示：
		</h1>
		<p style="margin:12px auto;padding:0px;line-height:22px;">
			在浏览器地址栏中访问：http://app.com，如果用户还未登陆则网站会自动重定向至：http://sso.com/passport，同时通过QueryString传参数的方式将对应的AppKey应用标识传递过来，运行截图如下：
		</p>
		<p style="margin:12px auto;padding:0px;line-height:22px;">
			URL地址：http://sso.com/passport?appkey=670b14728ad9902aecba32e22fa4f6bd&amp;username=
		</p>
		<p style="margin:12px auto;padding:0px;line-height:22px;">
			<img src="http://localhost:2363/upload/article/20160102214418_2329.png" alt="" style="margin:0px;padding:0px;max-width:1000px;" /> 
		</p>
		<p style="margin:12px auto;padding:0px;line-height:22px;">
			&nbsp;输入正确的登陆账号和密码后，点击登陆按钮系统自动301重定向至应用会掉首页，毁掉成功后如下所示：
		</p>
		<p style="margin:12px auto;padding:0px;line-height:22px;">
			<img src="http://localhost:2363/upload/article/20160102214421_0990.png" alt="" style="margin:0px;padding:0px;max-width:1000px;" /> 
		</p>
		<p style="margin:12px auto;padding:0px;line-height:22px;">
			&nbsp;由于在不同的域下进行SSO授权登陆，所以采用QueryString方式返回授权标识。同域网站下可采用Cookie方式。由于301重定向请求是由浏览器发送的，所以在如果授权标识放入Handers中的话，浏览器重定向的时候会丢失。重定向成功后，程序自动将授权标识写入到Cookie中，点击其他页面地址时，URL地址栏中将不再会看到授权标示信息。Cookie设置如下：
		</p>
		<p style="margin:12px auto;padding:0px;line-height:22px;">
			<img src="http://localhost:2363/upload/article/20160102214422_0611.png" alt="" style="margin:0px;padding:0px;max-width:1000px;" /> 
		</p>
		<p style="margin:12px auto;padding:0px;line-height:22px;">
			登陆成功后的后续授权验证（访问其他需要授权访问的页面）：
		</p>
		<p style="margin:12px auto;padding:0px;line-height:22px;">
			校验地址：http://sso.com/api/passport?sessionkey=xxxxxx&amp;remark=xxxxxx
		</p>
		<p style="margin:12px auto;padding:0px;line-height:22px;">
			返回结果：true，false
		</p>
		<p style="margin:12px auto;padding:0px;line-height:22px;">
			客户端可以根据实际业务情况，选择提示用户授权已丢失，需要重新获得授权。默认自动重定向至SSO登陆页面，即：http://sso.com/passport?appkey=670b14728ad9902aecba32e22fa4f6bd&amp;username=seo@ljja.cn 同时登陆页面邮箱地址文本框会自定补全用户的登陆账号，用户只需输入登陆密码即可，授权成功后会话有效期自动延长一年时间。
		</p>
		<h1 style="margin:0px;padding:0px;font-size:28px;">
			SSO数据库验证日志：
		</h1>
		<p style="margin:12px auto;padding:0px;line-height:22px;">
			用户授权验证日志：
		</p>
		<p style="margin:12px auto;padding:0px;line-height:22px;">
			<img src="http://localhost:2363/upload/article/20160102214422_3601.png" alt="" style="margin:0px;padding:0px;max-width:1000px;" /> 
		</p>
		<p style="margin:12px auto;padding:0px;line-height:22px;">
			用户授权会话Session：
		</p>
		<p style="margin:12px auto;padding:0px;line-height:22px;">
			<img src="http://localhost:2363/upload/article/20160102214424_2322.png" alt="" style="margin:0px;padding:0px;max-width:1000px;" /> 
		</p>
		<p style="margin:12px auto;padding:0px;line-height:22px;">
			数据库用户账号和应用信息：
		</p>
		<p style="margin:12px auto;padding:0px;line-height:22px;">
			<img src="http://localhost:2363/upload/article/20160102214424_5412.png" alt="" style="margin:0px;padding:0px;max-width:1000px;" /> 
		</p>
		<h1 style="margin:0px;padding:0px;font-size:28px;">
			应用授权登陆验证页面核心代码：
		</h1>
		<div class="cnblogs_code" style="margin:5px 0px;padding:5px;border:1px solid #CCCCCC;overflow:auto;font-family:'Courier New' !important;font-size:12px !important;background-color:#F5F5F5;">
			<div class="cnblogs_code_toolbar" style="margin:5px 0px 0px;padding:0px;">
				<span class="cnblogs_code_copy" style="margin:0px;padding:0px 5px 0px 0px;font-size:12px !important;line-height:1.5 !important;"><a title="复制代码" style="margin:0px;padding:0px;text-decoration:underline;border:none !important;"><img src="http://localhost:2363/upload/article/20160102214425_7003.gif" alt="复制代码" style="margin:0px;padding:0px;max-width:1000px;border-style:none !important;border-width:initial !important;" /></a></span> 
			</div>
<pre style="margin:0px;padding:0px;white-space:pre-wrap;word-wrap:break-word;font-family:'Courier New' !important;font-size:12px !important;"><span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;"> 1</span> <span style="margin:0px;padding:0px;color:#808080;font-size:12px !important;line-height:1.5 !important;">///</span> <span style="margin:0px;padding:0px;color:#808080;font-size:12px !important;line-height:1.5 !important;">&lt;summary&gt;</span> <span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;"> 2</span> <span style="margin:0px;padding:0px;color:#808080;font-size:12px !important;line-height:1.5 !important;">///</span><span style="margin:0px;padding:0px;color:#008000;font-size:12px !important;line-height:1.5 !important;"> 公钥：AppKey </span><span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;"> 3</span> <span style="margin:0px;padding:0px;color:#808080;font-size:12px !important;line-height:1.5 !important;">///</span><span style="margin:0px;padding:0px;color:#008000;font-size:12px !important;line-height:1.5 !important;"> 私钥：AppSecret </span><span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;"> 4</span> <span style="margin:0px;padding:0px;color:#808080;font-size:12px !important;line-height:1.5 !important;">///</span><span style="margin:0px;padding:0px;color:#008000;font-size:12px !important;line-height:1.5 !important;"> 会话：SessionKey </span><span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;"> 5</span> <span style="margin:0px;padding:0px;color:#808080;font-size:12px !important;line-height:1.5 !important;">///</span> <span style="margin:0px;padding:0px;color:#808080;font-size:12px !important;line-height:1.5 !important;">&lt;/summary&gt;</span> <span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;"> 6</span> <span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">public</span> <span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">class</span><span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;"> PassportController : Controller </span><span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;"> 7</span> <span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;"> { </span><span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;"> 8</span> <span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">private</span> <span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">readonly</span> IAppInfoService _appInfoService = <span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">new</span><span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;"> AppInfoService(); </span><span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;"> 9</span> <span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">private</span> <span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">readonly</span> IAppUserService _appUserService = <span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">new</span><span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;"> AppUserService(); </span><span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;"> 10</span> <span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">private</span> <span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">readonly</span> IUserAuthSessionService _authSessionService = <span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">new</span><span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;"> UserAuthSessionService(); </span><span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;"> 11</span> <span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">private</span> <span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">readonly</span> IUserAuthOperateService _userAuthOperateService = <span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">new</span><span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;"> UserAuthOperateService(); </span><span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;"> 12</span> <span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;"> 13</span> <span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">private</span> <span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">const</span> <span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">string</span> AppInfo = <span style="margin:0px;padding:0px;color:#800000;font-size:12px !important;line-height:1.5 !important;">"</span><span style="margin:0px;padding:0px;color:#800000;font-size:12px !important;line-height:1.5 !important;">AppInfo</span><span style="margin:0px;padding:0px;color:#800000;font-size:12px !important;line-height:1.5 !important;">"</span><span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;">; </span><span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;"> 14</span> <span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">private</span> <span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">const</span> <span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">string</span> SessionKey = <span style="margin:0px;padding:0px;color:#800000;font-size:12px !important;line-height:1.5 !important;">"</span><span style="margin:0px;padding:0px;color:#800000;font-size:12px !important;line-height:1.5 !important;">SessionKey</span><span style="margin:0px;padding:0px;color:#800000;font-size:12px !important;line-height:1.5 !important;">"</span><span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;">; </span><span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;"> 15</span> <span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">private</span> <span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">const</span> <span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">string</span> SessionUserName = <span style="margin:0px;padding:0px;color:#800000;font-size:12px !important;line-height:1.5 !important;">"</span><span style="margin:0px;padding:0px;color:#800000;font-size:12px !important;line-height:1.5 !important;">SessionUserName</span><span style="margin:0px;padding:0px;color:#800000;font-size:12px !important;line-height:1.5 !important;">"</span><span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;">; </span><span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;"> 16</span> <span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;"> 17</span> <span style="margin:0px;padding:0px;color:#008000;font-size:12px !important;line-height:1.5 !important;">//</span><span style="margin:0px;padding:0px;color:#008000;font-size:12px !important;line-height:1.5 !important;">默认登录界面</span> <span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;"> 18</span> <span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">public</span> ActionResult Index(<span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">string</span> appKey = <span style="margin:0px;padding:0px;color:#800000;font-size:12px !important;line-height:1.5 !important;">""</span>, <span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">string</span> username = <span style="margin:0px;padding:0px;color:#800000;font-size:12px !important;line-height:1.5 !important;">""</span><span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;">) </span><span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;"> 19</span> <span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;"> { </span><span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;"> 20</span> TempData[AppInfo] =<span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;"> _appInfoService.Get(appKey); </span><span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;"> 21</span> <span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;"> 22</span> <span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">var</span> viewModel = <span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">new</span><span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;"> PassportLoginRequest </span><span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;"> 23</span> <span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;"> { </span><span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;"> 24</span> AppKey =<span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;"> appKey, </span><span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;"> 25</span> UserName =<span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;"> username </span><span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;"> 26</span> <span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;"> }; </span><span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;"> 27</span> <span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;"> 28</span> <span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">return</span><span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;"> View(viewModel); </span><span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;"> 29</span> <span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;"> } </span><span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;"> 30</span> <span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;"> 31</span> <span style="margin:0px;padding:0px;color:#008000;font-size:12px !important;line-height:1.5 !important;">//</span><span style="margin:0px;padding:0px;color:#008000;font-size:12px !important;line-height:1.5 !important;">授权登录</span> <span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;"> 32</span> <span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;"> [HttpPost] </span><span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;"> 33</span> <span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">public</span><span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;"> ActionResult Index(PassportLoginRequest model) </span><span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;"> 34</span> <span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;"> { </span><span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;"> 35</span> <span style="margin:0px;padding:0px;color:#008000;font-size:12px !important;line-height:1.5 !important;">//</span><span style="margin:0px;padding:0px;color:#008000;font-size:12px !important;line-height:1.5 !important;">获取应用信息</span> <span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;"> 36</span> <span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">var</span> appInfo =<span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;"> _appInfoService.Get(model.AppKey); </span><span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;"> 37</span> <span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">if</span> (appInfo == <span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">null</span><span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;">) </span><span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;"> 38</span> <span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;"> { </span><span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;"> 39</span> <span style="margin:0px;padding:0px;color:#008000;font-size:12px !important;line-height:1.5 !important;">//</span><span style="margin:0px;padding:0px;color:#008000;font-size:12px !important;line-height:1.5 !important;">应用不存在</span> <span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;"> 40</span> <span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">return</span><span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;"> View(model); </span><span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;"> 41</span> <span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;"> } </span><span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;"> 42</span> <span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;"> 43</span> TempData[AppInfo] =<span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;"> appInfo; </span><span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;"> 44</span> <span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;"> 45</span> <span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">if</span> (ModelState.IsValid == <span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">false</span><span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;">) </span><span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;"> 46</span> <span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;"> { </span><span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;"> 47</span> <span style="margin:0px;padding:0px;color:#008000;font-size:12px !important;line-height:1.5 !important;">//</span><span style="margin:0px;padding:0px;color:#008000;font-size:12px !important;line-height:1.5 !important;">实体验证失败</span> <span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;"> 48</span> <span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">return</span><span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;"> View(model); </span><span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;"> 49</span> <span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;"> } </span><span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;"> 50</span> <span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;"> 51</span> <span style="margin:0px;padding:0px;color:#008000;font-size:12px !important;line-height:1.5 !important;">//</span><span style="margin:0px;padding:0px;color:#008000;font-size:12px !important;line-height:1.5 !important;">过滤字段无效字符</span> <span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;"> 52</span> <span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;"> model.Trim(); </span><span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;"> 53</span> <span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;"> 54</span> <span style="margin:0px;padding:0px;color:#008000;font-size:12px !important;line-height:1.5 !important;">//</span><span style="margin:0px;padding:0px;color:#008000;font-size:12px !important;line-height:1.5 !important;">获取用户信息</span> <span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;"> 55</span> <span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">var</span> userInfo =<span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;"> _appUserService.Get(model.UserName); </span><span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;"> 56</span> <span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">if</span> (userInfo == <span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">null</span><span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;">) </span><span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;"> 57</span> <span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;"> { </span><span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;"> 58</span> <span style="margin:0px;padding:0px;color:#008000;font-size:12px !important;line-height:1.5 !important;">//</span><span style="margin:0px;padding:0px;color:#008000;font-size:12px !important;line-height:1.5 !important;">用户不存在</span> <span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;"> 59</span> <span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">return</span><span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;"> View(model); </span><span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;"> 60</span> <span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;"> } </span><span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;"> 61</span> <span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;"> 62</span> <span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">if</span> (userInfo.UserPwd !=<span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;"> model.Password.ToMd5()) </span><span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;"> 63</span> <span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;"> { </span><span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;"> 64</span> <span style="margin:0px;padding:0px;color:#008000;font-size:12px !important;line-height:1.5 !important;">//</span><span style="margin:0px;padding:0px;color:#008000;font-size:12px !important;line-height:1.5 !important;">密码不正确</span> <span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;"> 65</span> <span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">return</span><span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;"> View(model); </span><span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;"> 66</span> <span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;"> } </span><span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;"> 67</span> <span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;"> 68</span> <span style="margin:0px;padding:0px;color:#008000;font-size:12px !important;line-height:1.5 !important;">//</span><span style="margin:0px;padding:0px;color:#008000;font-size:12px !important;line-height:1.5 !important;">获取当前未到期的Session</span> <span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;"> 69</span> <span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">var</span> currentSession =<span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;"> _authSessionService.ExistsByValid(appInfo.AppKey, userInfo.UserName); </span><span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;"> 70</span> <span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">if</span> (currentSession == <span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">null</span><span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;">) </span><span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;"> 71</span> <span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;"> { </span><span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;"> 72</span> <span style="margin:0px;padding:0px;color:#008000;font-size:12px !important;line-height:1.5 !important;">//</span><span style="margin:0px;padding:0px;color:#008000;font-size:12px !important;line-height:1.5 !important;">构建Session</span> <span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;"> 73</span> currentSession = <span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">new</span><span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;"> UserAuthSession </span><span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;"> 74</span> <span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;"> { </span><span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;"> 75</span> AppKey =<span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;"> appInfo.AppKey, </span><span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;"> 76</span> CreateTime =<span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;"> DateTime.Now, </span><span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;"> 77</span> InvalidTime = DateTime.Now.AddYears(<span style="margin:0px;padding:0px;color:#800080;font-size:12px !important;line-height:1.5 !important;">1</span><span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;">), </span><span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;"> 78</span> IpAddress =<span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;"> Request.UserHostAddress, </span><span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;"> 79</span> SessionKey =<span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;"> Guid.NewGuid().ToString().ToMd5(), </span><span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;"> 80</span> UserName =<span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;"> userInfo.UserName </span><span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;"> 81</span> <span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;"> }; </span><span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;"> 82</span> <span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;"> 83</span> <span style="margin:0px;padding:0px;color:#008000;font-size:12px !important;line-height:1.5 !important;">//</span><span style="margin:0px;padding:0px;color:#008000;font-size:12px !important;line-height:1.5 !important;">创建Session</span> <span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;"> 84</span> <span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;"> _authSessionService.Create(currentSession); </span><span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;"> 85</span> <span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;"> } </span><span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;"> 86</span> <span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">else</span> <span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;"> 87</span> <span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;"> { </span><span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;"> 88</span> <span style="margin:0px;padding:0px;color:#008000;font-size:12px !important;line-height:1.5 !important;">//</span><span style="margin:0px;padding:0px;color:#008000;font-size:12px !important;line-height:1.5 !important;">延长有效期，默认一年</span> <span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;"> 89</span> <span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;"> _authSessionService.ExtendValid(currentSession.SessionKey); </span><span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;"> 90</span> <span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;"> } </span><span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;"> 91</span> <span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;"> 92</span> <span style="margin:0px;padding:0px;color:#008000;font-size:12px !important;line-height:1.5 !important;">//</span><span style="margin:0px;padding:0px;color:#008000;font-size:12px !important;line-height:1.5 !important;">记录用户授权日志</span> <span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;"> 93</span> _userAuthOperateService.Create(<span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">new</span><span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;"> UserAuthOperate </span><span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;"> 94</span> <span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;"> { </span><span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;"> 95</span> CreateTime =<span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;"> DateTime.Now, </span><span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;"> 96</span> IpAddress =<span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;"> Request.UserHostAddress, </span><span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;"> 97</span> Remark = <span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">string</span>.Format(<span style="margin:0px;padding:0px;color:#800000;font-size:12px !important;line-height:1.5 !important;">"</span><span style="margin:0px;padding:0px;color:#800000;font-size:12px !important;line-height:1.5 !important;">{0} 登录 {1} 授权成功</span><span style="margin:0px;padding:0px;color:#800000;font-size:12px !important;line-height:1.5 !important;">"</span><span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;">, currentSession.UserName, appInfo.Title), </span><span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;"> 98</span> SessionKey =<span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;"> currentSession.SessionKey </span><span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;"> 99</span> <span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;"> });</span> <span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;">104</span> <span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;">105</span> <span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">var</span> redirectUrl = <span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">string</span>.Format(<span style="margin:0px;padding:0px;color:#800000;font-size:12px !important;line-height:1.5 !important;">"</span><span style="margin:0px;padding:0px;color:#800000;font-size:12px !important;line-height:1.5 !important;">{0}?SessionKey={1}&amp;SessionUserName={2}</span><span style="margin:0px;padding:0px;color:#800000;font-size:12px !important;line-height:1.5 !important;">"</span><span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;">, </span><span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;">106</span> <span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;"> appInfo.ReturnUrl, </span><span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;">107</span> <span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;"> currentSession.SessionKey, </span><span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;">108</span> <span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;"> userInfo.UserName); </span><span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;">109</span> <span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;">110</span> <span style="margin:0px;padding:0px;color:#008000;font-size:12px !important;line-height:1.5 !important;">//</span><span style="margin:0px;padding:0px;color:#008000;font-size:12px !important;line-height:1.5 !important;">跳转默认回调页面</span> <span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;">111</span> <span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">return</span><span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;"> Redirect(redirectUrl); </span><span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;">112</span> <span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;"> } </span><span style="margin:0px;padding:0px;color:#008080;font-size:12px !important;line-height:1.5 !important;">113</span> }</pre>
			<div class="cnblogs_code_toolbar" style="margin:5px 0px 0px;padding:0px;">
				<span class="cnblogs_code_copy" style="margin:0px;padding:0px 5px 0px 0px;font-size:12px !important;line-height:1.5 !important;"><a title="复制代码" style="margin:0px;padding:0px;text-decoration:underline;border:none !important;"><img src="http://localhost:2363/upload/article/20160102214425_7003.gif" alt="复制代码" style="margin:0px;padding:0px;max-width:1000px;border-style:none !important;border-width:initial !important;" /></a></span> 
			</div>
		</div>
		<p style="margin:12px auto;padding:0px;line-height:22px;">
			&nbsp;
		</p>
		<h1 style="margin:0px;padding:0px;font-size:28px;">
			Memcached会话标识验证核心代码：
		</h1>
		<div class="cnblogs_code" style="margin:5px 0px;padding:5px;border:1px solid #CCCCCC;overflow:auto;font-family:'Courier New' !important;font-size:12px !important;background-color:#F5F5F5;">
			<div class="cnblogs_code_toolbar" style="margin:5px 0px 0px;padding:0px;">
				<span class="cnblogs_code_copy" style="margin:0px;padding:0px 5px 0px 0px;font-size:12px !important;line-height:1.5 !important;"><a title="复制代码" style="margin:0px;padding:0px;text-decoration:underline;border:none !important;"><img src="http://localhost:2363/upload/article/20160102214425_7003.gif" alt="复制代码" style="margin:0px;padding:0px;max-width:1000px;border-style:none !important;border-width:initial !important;" /></a></span> 
			</div>
<pre style="margin:0px;padding:0px;white-space:pre-wrap;word-wrap:break-word;font-family:'Courier New' !important;font-size:12px !important;"><span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">public</span> <span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">class</span><span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;"> PassportController : ApiController
    { </span><span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">private</span> <span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">readonly</span> IUserAuthSessionService _authSessionService = <span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">new</span><span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;"> UserAuthSessionService(); </span><span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">private</span> <span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">readonly</span> IUserAuthOperateService _userAuthOperateService = <span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">new</span><span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;"> UserAuthOperateService(); </span><span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">public</span> <span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">bool</span> Get(<span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">string</span> sessionKey = <span style="margin:0px;padding:0px;color:#800000;font-size:12px !important;line-height:1.5 !important;">""</span>, <span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">string</span> remark = <span style="margin:0px;padding:0px;color:#800000;font-size:12px !important;line-height:1.5 !important;">""</span><span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;">)
        { </span><span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">if</span><span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;"> (_authSessionService.GetCache(sessionKey))
            {
                _userAuthOperateService.Create(</span><span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">new</span><span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;"> UserAuthOperate
                {
                    CreateTime </span>=<span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;"> DateTime.Now,
                    IpAddress </span>=<span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;"> Request.RequestUri.Host,
                    Remark </span>= <span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">string</span>.Format(<span style="margin:0px;padding:0px;color:#800000;font-size:12px !important;line-height:1.5 !important;">"</span><span style="margin:0px;padding:0px;color:#800000;font-size:12px !important;line-height:1.5 !important;">验证成功-{0}</span><span style="margin:0px;padding:0px;color:#800000;font-size:12px !important;line-height:1.5 !important;">"</span><span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;">, remark),
                    SessionKey </span>=<span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;"> sessionKey
                }); </span><span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">return</span> <span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">true</span><span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;">;
            }

            _userAuthOperateService.Create(</span><span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">new</span><span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;"> UserAuthOperate
            {
                CreateTime </span>=<span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;"> DateTime.Now,
                IpAddress </span>=<span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;"> Request.RequestUri.Host,
                Remark </span>= <span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">string</span>.Format(<span style="margin:0px;padding:0px;color:#800000;font-size:12px !important;line-height:1.5 !important;">"</span><span style="margin:0px;padding:0px;color:#800000;font-size:12px !important;line-height:1.5 !important;">验证失败-{0}</span><span style="margin:0px;padding:0px;color:#800000;font-size:12px !important;line-height:1.5 !important;">"</span><span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;">, remark),
                SessionKey </span>=<span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;"> sessionKey
            }); </span><span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">return</span> <span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">false</span><span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;">;
        }
    }</span></pre>
			<div class="cnblogs_code_toolbar" style="margin:5px 0px 0px;padding:0px;">
				<span class="cnblogs_code_copy" style="margin:0px;padding:0px 5px 0px 0px;font-size:12px !important;line-height:1.5 !important;"><a title="复制代码" style="margin:0px;padding:0px;text-decoration:underline;border:none !important;"><img src="http://localhost:2363/upload/article/20160102214425_7003.gif" alt="复制代码" style="margin:0px;padding:0px;max-width:1000px;border-style:none !important;border-width:initial !important;" /></a></span> 
			</div>
		</div>
		<p style="margin:12px auto;padding:0px;line-height:22px;">
			&nbsp;
		</p>
		<h1 style="margin:0px;padding:0px;font-size:28px;">
			Client授权验证Filters Attribute
		</h1>
		<div class="cnblogs_code" style="margin:5px 0px;padding:5px;border:1px solid #CCCCCC;overflow:auto;font-family:'Courier New' !important;font-size:12px !important;background-color:#F5F5F5;">
			<div class="cnblogs_code_toolbar" style="margin:5px 0px 0px;padding:0px;">
				<span class="cnblogs_code_copy" style="margin:0px;padding:0px 5px 0px 0px;font-size:12px !important;line-height:1.5 !important;"><a title="复制代码" style="margin:0px;padding:0px;text-decoration:underline;border:none !important;"><img src="http://localhost:2363/upload/article/20160102214425_7003.gif" alt="复制代码" style="margin:0px;padding:0px;max-width:1000px;border-style:none !important;border-width:initial !important;" /></a></span> 
			</div>
<pre style="margin:0px;padding:0px;white-space:pre-wrap;word-wrap:break-word;font-family:'Courier New' !important;font-size:12px !important;"><span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">public</span> <span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">class</span><span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;"> SSOAuthAttribute : ActionFilterAttribute
    { </span><span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">public</span> <span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">const</span> <span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">string</span> SessionKey = <span style="margin:0px;padding:0px;color:#800000;font-size:12px !important;line-height:1.5 !important;">"</span><span style="margin:0px;padding:0px;color:#800000;font-size:12px !important;line-height:1.5 !important;">SessionKey</span><span style="margin:0px;padding:0px;color:#800000;font-size:12px !important;line-height:1.5 !important;">"</span><span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;">; </span><span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">public</span> <span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">const</span> <span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">string</span> SessionUserName = <span style="margin:0px;padding:0px;color:#800000;font-size:12px !important;line-height:1.5 !important;">"</span><span style="margin:0px;padding:0px;color:#800000;font-size:12px !important;line-height:1.5 !important;">SessionUserName</span><span style="margin:0px;padding:0px;color:#800000;font-size:12px !important;line-height:1.5 !important;">"</span><span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;">; </span><span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">public</span> <span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">override</span> <span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">void</span><span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;"> OnActionExecuting(ActionExecutingContext filterContext)
        { </span><span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">var</span> cookieSessionkey = <span style="margin:0px;padding:0px;color:#800000;font-size:12px !important;line-height:1.5 !important;">""</span><span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;">; </span><span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">var</span> cookieSessionUserName = <span style="margin:0px;padding:0px;color:#800000;font-size:12px !important;line-height:1.5 !important;">""</span><span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;">; </span><span style="margin:0px;padding:0px;color:#008000;font-size:12px !important;line-height:1.5 !important;">//</span><span style="margin:0px;padding:0px;color:#008000;font-size:12px !important;line-height:1.5 !important;">SessionKey by QueryString</span> <span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">if</span> (filterContext.HttpContext.Request.QueryString[SessionKey] != <span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">null</span><span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;">)
            {
                cookieSessionkey </span>=<span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;"> filterContext.HttpContext.Request.QueryString[SessionKey];
                filterContext.HttpContext.Response.Cookies.Add(</span><span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">new</span><span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;"> HttpCookie(SessionKey, cookieSessionkey));
            } </span><span style="margin:0px;padding:0px;color:#008000;font-size:12px !important;line-height:1.5 !important;">//</span><span style="margin:0px;padding:0px;color:#008000;font-size:12px !important;line-height:1.5 !important;">SessionUserName by QueryString</span> <span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">if</span> (filterContext.HttpContext.Request.QueryString[SessionUserName] != <span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">null</span><span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;">)
            {
                cookieSessionUserName </span>=<span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;"> filterContext.HttpContext.Request.QueryString[SessionUserName];
                filterContext.HttpContext.Response.Cookies.Add(</span><span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">new</span><span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;"> HttpCookie(SessionUserName, cookieSessionUserName));
            } </span><span style="margin:0px;padding:0px;color:#008000;font-size:12px !important;line-height:1.5 !important;">//</span><span style="margin:0px;padding:0px;color:#008000;font-size:12px !important;line-height:1.5 !important;">从Cookie读取SessionKey</span> <span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">if</span> (filterContext.HttpContext.Request.Cookies[SessionKey] != <span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">null</span><span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;">)
            {
                cookieSessionkey </span>=<span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;"> filterContext.HttpContext.Request.Cookies[SessionKey].Value;
            } </span><span style="margin:0px;padding:0px;color:#008000;font-size:12px !important;line-height:1.5 !important;">//</span><span style="margin:0px;padding:0px;color:#008000;font-size:12px !important;line-height:1.5 !important;">从Cookie读取SessionUserName</span> <span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">if</span> (filterContext.HttpContext.Request.Cookies[SessionUserName] != <span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">null</span><span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;">)
            {
                cookieSessionUserName </span>=<span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;"> filterContext.HttpContext.Request.Cookies[SessionUserName].Value;
            } </span><span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">if</span> (<span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">string</span>.IsNullOrEmpty(cookieSessionkey) || <span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">string</span><span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;">.IsNullOrEmpty(cookieSessionUserName))
            { </span><span style="margin:0px;padding:0px;color:#008000;font-size:12px !important;line-height:1.5 !important;">//</span><span style="margin:0px;padding:0px;color:#008000;font-size:12px !important;line-height:1.5 !important;">直接登录</span> filterContext.Result =<span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;"> SsoLoginResult(cookieSessionUserName);
            } </span><span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">else</span><span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;"> { </span><span style="margin:0px;padding:0px;color:#008000;font-size:12px !important;line-height:1.5 !important;">//</span><span style="margin:0px;padding:0px;color:#008000;font-size:12px !important;line-height:1.5 !important;">验证</span> <span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">if</span> (CheckLogin(cookieSessionkey, filterContext.HttpContext.Request.RawUrl) == <span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">false</span><span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;">)
                { </span><span style="margin:0px;padding:0px;color:#008000;font-size:12px !important;line-height:1.5 !important;">//</span><span style="margin:0px;padding:0px;color:#008000;font-size:12px !important;line-height:1.5 !important;">会话丢失，跳转到登录页面</span> filterContext.Result =<span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;"> SsoLoginResult(cookieSessionUserName);
                }
            } </span><span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">base</span><span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;">.OnActionExecuting(filterContext);
        } </span><span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">public</span> <span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">static</span> <span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">bool</span> CheckLogin(<span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">string</span> sessionKey, <span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">string</span> remark = <span style="margin:0px;padding:0px;color:#800000;font-size:12px !important;line-height:1.5 !important;">""</span><span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;">)
        { </span><span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">var</span> httpClient = <span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">new</span><span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;"> HttpClient
            {
                BaseAddress </span>= <span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">new</span> Uri(ConfigurationManager.AppSettings[<span style="margin:0px;padding:0px;color:#800000;font-size:12px !important;line-height:1.5 !important;">"</span><span style="margin:0px;padding:0px;color:#800000;font-size:12px !important;line-height:1.5 !important;">SSOPassport</span><span style="margin:0px;padding:0px;color:#800000;font-size:12px !important;line-height:1.5 !important;">"</span><span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;">])
            }; </span><span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">var</span> requestUri = <span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">string</span>.Format(<span style="margin:0px;padding:0px;color:#800000;font-size:12px !important;line-height:1.5 !important;">"</span><span style="margin:0px;padding:0px;color:#800000;font-size:12px !important;line-height:1.5 !important;">api/Passport?sessionKey={0}&amp;remark={1}</span><span style="margin:0px;padding:0px;color:#800000;font-size:12px !important;line-height:1.5 !important;">"</span><span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;">, sessionKey, remark); </span><span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">try</span><span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;"> { </span><span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">var</span> resp =<span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;"> httpClient.GetAsync(requestUri).Result;

                resp.EnsureSuccessStatusCode(); </span><span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">return</span> resp.Content.ReadAsAsync&lt;<span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">bool</span>&gt;<span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;">().Result;
            } </span><span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">catch</span><span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;"> (Exception ex)
            { </span><span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">throw</span><span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;"> ex;
            }
        } </span><span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">private</span> <span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">static</span> ActionResult SsoLoginResult(<span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">string</span><span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;"> username)
        { </span><span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">return</span> <span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">new</span> RedirectResult(<span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">string</span>.Format(<span style="margin:0px;padding:0px;color:#800000;font-size:12px !important;line-height:1.5 !important;">"</span><span style="margin:0px;padding:0px;color:#800000;font-size:12px !important;line-height:1.5 !important;">{0}/passport?appkey={1}&amp;username={2}</span><span style="margin:0px;padding:0px;color:#800000;font-size:12px !important;line-height:1.5 !important;">"</span><span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;">,
                    ConfigurationManager.AppSettings[</span><span style="margin:0px;padding:0px;color:#800000;font-size:12px !important;line-height:1.5 !important;">"</span><span style="margin:0px;padding:0px;color:#800000;font-size:12px !important;line-height:1.5 !important;">SSOPassport</span><span style="margin:0px;padding:0px;color:#800000;font-size:12px !important;line-height:1.5 !important;">"</span><span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;">],
                    ConfigurationManager.AppSettings[</span><span style="margin:0px;padding:0px;color:#800000;font-size:12px !important;line-height:1.5 !important;">"</span><span style="margin:0px;padding:0px;color:#800000;font-size:12px !important;line-height:1.5 !important;">SSOAppKey</span><span style="margin:0px;padding:0px;color:#800000;font-size:12px !important;line-height:1.5 !important;">"</span><span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;">],
                    username));
        }
    }</span></pre>
			<div class="cnblogs_code_toolbar" style="margin:5px 0px 0px;padding:0px;">
				<span class="cnblogs_code_copy" style="margin:0px;padding:0px 5px 0px 0px;font-size:12px !important;line-height:1.5 !important;"><a title="复制代码" style="margin:0px;padding:0px;text-decoration:underline;border:none !important;"><img src="http://localhost:2363/upload/article/20160102214425_7003.gif" alt="复制代码" style="margin:0px;padding:0px;max-width:1000px;border-style:none !important;border-width:initial !important;" /></a></span> 
			</div>
		</div>
		<p style="margin:12px auto;padding:0px;line-height:22px;">
			&nbsp;
		</p>
		<h1 style="margin:0px;padding:0px;font-size:28px;">
			示例SSO验证特性使用方法：
		</h1>
		<div class="cnblogs_code" style="margin:5px 0px;padding:5px;border:1px solid #CCCCCC;overflow:auto;font-family:'Courier New' !important;font-size:12px !important;background-color:#F5F5F5;">
			<div class="cnblogs_code_toolbar" style="margin:5px 0px 0px;padding:0px;">
				<span class="cnblogs_code_copy" style="margin:0px;padding:0px 5px 0px 0px;font-size:12px !important;line-height:1.5 !important;"><a title="复制代码" style="margin:0px;padding:0px;text-decoration:underline;border:none !important;"><img src="http://localhost:2363/upload/article/20160102214425_7003.gif" alt="复制代码" style="margin:0px;padding:0px;max-width:1000px;border-style:none !important;border-width:initial !important;" /></a></span> 
			</div>
<pre style="margin:0px;padding:0px;white-space:pre-wrap;word-wrap:break-word;font-family:'Courier New' !important;font-size:12px !important;"><span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;">[SSOAuth] </span><span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">public</span> <span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">class</span><span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;"> HomeController : Controller
    { </span><span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">public</span><span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;"> ActionResult Index()
        { </span><span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">return</span><span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;"> View();
        } </span><span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">public</span><span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;"> ActionResult About()
        {
            ViewBag.Message </span>= <span style="margin:0px;padding:0px;color:#800000;font-size:12px !important;line-height:1.5 !important;">"</span><span style="margin:0px;padding:0px;color:#800000;font-size:12px !important;line-height:1.5 !important;">Your application description page.</span><span style="margin:0px;padding:0px;color:#800000;font-size:12px !important;line-height:1.5 !important;">"</span><span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;">; </span><span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">return</span><span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;"> View();
        } </span><span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">public</span><span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;"> ActionResult Contact()
        {
            ViewBag.Message </span>= <span style="margin:0px;padding:0px;color:#800000;font-size:12px !important;line-height:1.5 !important;">"</span><span style="margin:0px;padding:0px;color:#800000;font-size:12px !important;line-height:1.5 !important;">Your contact page.</span><span style="margin:0px;padding:0px;color:#800000;font-size:12px !important;line-height:1.5 !important;">"</span><span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;">; </span><span style="margin:0px;padding:0px;color:#0000FF;font-size:12px !important;line-height:1.5 !important;">return</span><span style="margin:0px;padding:0px;font-size:12px !important;line-height:1.5 !important;"> View();
        }
    }</span></pre>
			<div class="cnblogs_code_toolbar" style="margin:5px 0px 0px;padding:0px;">
				<span class="cnblogs_code_copy" style="margin:0px;padding:0px 5px 0px 0px;font-size:12px !important;line-height:1.5 !important;"><a title="复制代码" style="margin:0px;padding:0px;text-decoration:underline;border:none !important;"><img src="http://localhost:2363/upload/article/20160102214425_7003.gif" alt="复制代码" style="margin:0px;padding:0px;max-width:1000px;border-style:none !important;border-width:initial !important;" /></a></span> 
			</div>
		</div>
		<p style="margin:12px auto;padding:0px;line-height:22px;">
			&nbsp;
		</p>
		<h1 style="margin:0px;padding:0px;font-size:28px;">
			总结：
		</h1>
		<p style="margin:12px auto;padding:0px;line-height:22px;">
			从草稿示例代码中可以看到代码性能上还有很多优化的地方，还有SSO应用授权登陆页面的用户账号不存在、密码错误等一系列的提示信息等。在业务代码运行基本正确的后期，可以考虑往更多的安全性层面优化，比如启用AppSecret私钥签名验证，IP范围验证，固定会话请求攻击、SSO授权登陆界面的验证码、会话缓存自动重建、SSo服务器、缓存的水平扩展等。
		</p>
		<p style="margin:12px auto;padding:0px;line-height:22px;">
			源码地址：https://github.com/smartbooks/SmartSSO
		</p>
	</div>
</div></div>
        <div class="article_tag muted">
                <a class="grayBoxA" href="http://localhost:8080/tag/MVC">MVC</a>
                <a class="grayBoxA" href="http://localhost:8080/tag/sso%e5%8d%95%e7%82%b9%e7%99%bb%e5%bd%95">sso单点登录</a>
        </div>
        <div class="vote articlevote clearfix" voteid="14">
            <ul>
                <li>顶 :</li>
                <li class="vote_favor vote_favor_value"></li>
                <li class="gap"></li>
                <li>踩 :</li>
                <li class="vote_against vote_against_value"></li>
                <li class="vote_tip"></li>
            </ul>
        </div>
        <div class="article_link"></div>
        <div class="article_comment">
            <input type="hidden" value="desc" id="CommentOrderType" name="CommentOrderType"/>
            <a name="commentA"></a>
            <div id="commentlist">
            </div>
            <div id="commentform">
                <a name="commentFormA"></a>
                <h4>发表评论</h4>
                <div id="commentFormWrap"></div>
            </div>
        </div>
    </div>
</div>
<input type="hidden" value="" id="current-comment" name="current-comment"/>
<div id="modalbackdroptrue" class="modal hide fade">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h3>删除评论</h3>
    </div>
    <div class="modal-body">
        <p>
            确定删除选中项?
        </p>
    </div>
    <div class="modal-footer">
        <a class="btn btn-success fl" id="comment-delete-yes">是</a>
        <a data-dismiss="modal" class="btn btn-danger fl" id="comment-delete-no">否</a>
    </div>
</div>


        </div>
        <footer>
            <div class="container">
                版权所有  &copy; xxxx_jery_company
            </div>
        </footer>
<div id="themeSwitch">
    <a id="viewThemeList"><span class="ui-icon ui-icon-gear"></span></a>
    <div class="popover right nodisplay" id="themlistWrap">
        <div class="arrow"></div>
        <button class="close" type="button">×</button>
        <h3 class="popover-title clearfix">
            模板设置
        </h3>
        <div class="popover-content">
            <p class="currenttheme">Default</p>
            <ul>
                    <li><span class="themeindex">1</span><a href="?theme=bs3">BootStrap3</a></li>
            </ul>
        </div>
    </div>
</div>        
    <script src="/Scripts/SyntaxHighlighter/scripts/shCore.js" type="text/javascript"></script>
    <script src="/Scripts/SyntaxHighlighter/scripts/shBrush.js" type="text/javascript"></script>
    <script type="text/javascript">
        $(function () {
            $('.article_link').html(loadingImgSmall);
            GetArticleAjaxInfo();
            GetCommentForm();
            SyntaxHighlighter.all();
        });
    </script>

    
<!-- Visual Studio Browser Link -->
<script type="application/json" id="__browserLink_initializationData">
    {"appName":"Unknown"}
</script>
<script type="text/javascript" src="http://localhost:52802/d7b292a5fb244ceb8c4b180f13d5cf01/browserLink" async="async"></script>
<!-- End Browser Link -->

</body>
</html>